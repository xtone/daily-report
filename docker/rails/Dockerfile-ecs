FROM public.ecr.aws/docker/library/ruby:3.1.6
ENV LANG=C.UTF-8

# 必要なパッケージをインストール
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        curl \
        ca-certificates \
        libmariadb-dev-compat \
        python3 \
        make \
        g++ && \
    rm -rf /var/lib/apt/lists/*

# Node.js 18.x をインストール（Debian標準パッケージ）
RUN apt-get update && \
    apt-get install -y nodejs npm && \
    rm -rf /var/lib/apt/lists/* && \
    node --version && \
    npm --version

# Yarnをnpmでインストール
RUN npm install -g yarn@1.22.19

# Ruby 3.1で使用可能な最新のBundler 2.4.22をインストール
RUN gem update --system 3.4.22 && gem install bundler -v 2.4.22

ENV APP_ROOT=/daily-report
RUN mkdir -p $APP_ROOT
WORKDIR $APP_ROOT

# アプリケーションコードをコピー
COPY . $APP_ROOT

RUN yarn install --frozen-lockfile

RUN bundle config set --local deployment 'true' && \
    bundle config set --local without 'development test' && \
    bundle _2.4.22_ install --jobs 4 --retry 3

# 本番環境用の環境変数を設定
ENV RAILS_ENV=production
ENV NODE_ENV=production
ENV RAILS_SERVE_STATIC_FILES=true
ENV RAILS_LOG_TO_STDOUT=true

# webpacker用の環境変数を追加
ENV NODE_OPTIONS="--max-old-space-size=4096"

# webpackerのキャッシュディレクトリを作成
RUN mkdir -p tmp/cache/webpacker public/packs scripts

# scriptsディレクトリを作成してマニフェスト生成スクリプトをコピー
COPY scripts/generate-manifest.js scripts/

# 古いwebpackerファイルを削除
RUN rm -rf public/packs/*

# Railsのassets:precompileでCSSなどの残りのアセットを処理（webpackerファイルは除く）
RUN RAILS_ENV=production \
    SECRET_KEY_BASE=dummy \
    DISABLE_SPRING=1 \
    RAILS_LOG_LEVEL=error \
    DISABLE_DATABASE_ENVIRONMENT_CHECK=1 \
    bundle exec rails assets:precompile

# 本番環境用のwebpackビルドを実行（Railsアセットプリコンパイル後）
RUN NODE_ENV=production npm run build

# マニフェストファイルを再生成（webpackとRailsアセットの両方を含む）
RUN npm run postbuild

# 本番環境では不要なdevDependenciesを削除してイメージサイズを削減
RUN yarn install --production && yarn cache clean

# PIDファイルとtmpディレクトリをクリーンアップ
RUN rm -rf tmp/pids/* tmp/cache/* && mkdir -p tmp/pids

EXPOSE 3000

# 本番環境用の起動コマンド（PIDファイルを削除してから起動）
CMD ["sh", "-c", "rm -f tmp/pids/server.pid && bundle exec rails server -b 0.0.0.0 -p 3000 -e production"]
