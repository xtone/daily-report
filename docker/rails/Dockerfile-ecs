FROM public.ecr.aws/docker/library/ruby:2.5.9
ENV LANG C.UTF-8

# aptの設定を更新してGPGチェックを無効化
RUN echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/90ignore-release-date && \
    echo 'APT::Get::AllowUnauthenticated "true";' > /etc/apt/apt.conf.d/99verify-peer && \
    echo "deb [trusted=yes] http://archive.debian.org/debian stretch main" > /etc/apt/sources.list && \
    echo "deb-src [trusted=yes] http://archive.debian.org/debian stretch main" >> /etc/apt/sources.list && \
    apt-get update -o Acquire::Check-Valid-Until=false -qq || true && \
    apt-get install -y --allow-unauthenticated --no-install-recommends \
        build-essential \
        curl \
        ca-certificates \
        libmariadb-dev-compat && \
    rm -rf /var/lib/apt/lists/*

# Node.js 8.12.0を直接バイナリからインストール
RUN curl -fsSL https://nodejs.org/dist/v8.12.0/node-v8.12.0-linux-x64.tar.xz | tar -xJ -C /usr/local --strip-components=1 && \
    node --version && \
    npm --version

# Yarnをnpmでインストール
RUN npm install -g yarn@1.22.19

# Bundler 2.0.2をインストール（Ruby 2.4.2と互換性があり、Bundler 2形式のlockfileを読める）
RUN gem update --system 3.0.8 && gem install bundler -v 2.3.18

ENV APP_ROOT /daily-report
RUN mkdir -p $APP_ROOT
WORKDIR $APP_ROOT

EXPOSE 3000

COPY . $APP_ROOT
RUN bundle install
RUN bin/rake assets:precompile
