# Rails 7.0アップグレード準備作業

## 現状確認

### バージョン情報
- **現在のRails**: 6.1.7.10（最新パッチバージョン）
- **Ruby**: 2.7.8（Rails 7.0対応済み）
- **Node.js**: 14.x

### テストスイート状況
- **総テスト数**: 400例
- **失敗**: 34例（主にデータ設定の問題）
- **保留**: 59例（未実装のテスト）
- **実動作可能**: 307例（約77%）

### Deprecation Warning
- Rails 6.1からRails 7.0への移行では、大きなdeprecation warningは確認されませんでした
- 自動読み込み（autoloading）は適切に設定済み

## 依存Gemの互換性確認

### ✅ Rails 7.0対応済み
| Gem | 現在バージョン | 必要なアクション |
|-----|--------------|----------------|
| jsbundling-rails | 最新 | なし（Rails 7推奨） |
| pundit | 最新 | なし |
| jquery-rails | 最新 | なし |

### ⚠️ アップデート必要
| Gem | 現在バージョン | 推奨バージョン | 理由 |
|-----|--------------|--------------|------|
| devise | >= 4.7.0 | >= 4.8.1 | Rails 7.0互換性 |
| slim-rails | 確認必要 | >= 3.5.1 | Rails 7スタイルテンプレート |

### 🔄 移行検討が必要
| Gem | 現在 | 推奨代替 | 理由 |
|-----|------|---------|------|
| turbolinks | ~> 5 | Turbo (Hotwire) | 非推奨・保守終了 |
| sass-rails | 6+ | cssbundling-rails | より現代的な構成 |

## セキュリティ脆弱性

### 重要度高
- **actionpack** 6.1.7.10: CSP bypass脆弱性
- **puma** 3.12.6: 複数の深刻な脆弱性
- **nokogiri** 1.15.7: 複数のlibxml2脆弱性

### 対策
1. Rails 7.0アップグレード時に自動的に解決される脆弱性
2. puma を 5.6.9+ または 6.4.3+ へアップグレード
3. nokogiri を 1.18.8+ へアップグレード

## アップグレード準備チェックリスト

### Phase 1: 依存関係の更新
- [ ] devise を 4.8.1+ へアップグレード
- [ ] slim-rails を 3.5.1+ へアップグレード
- [ ] puma を 5.6.9+ へアップグレード
- [ ] nokogiri を 1.18.8+ へアップグレード

### Phase 2: 設定の準備
- [ ] config/application.rb の Rails 7.0対応設定追加
- [ ] config/environments/*.rb の新設定項目確認
- [ ] initializers の互換性確認

### Phase 3: アセット管理の確認
- [ ] jsbundling-rails の設定確認
- [ ] Webpack設定の動作確認
- [ ] CSS/JavaScript ビルドプロセスの検証

### Phase 4: テストの修正
- [ ] 失敗している34テストの修正
- [ ] Rails 7.0固有のテスト調整
- [ ] E2Eテストの動作確認

## 移行時の注意点

### 破壊的変更
1. **Active Support の変更**
   - `ActiveSupport::Dependencies` の動作変更
   - autoloading の改善

2. **Action Pack の変更**
   - CSRFトークンの扱い変更
   - Strong Parameters の挙動変更

3. **Active Record の変更**
   - クエリメソッドの一部変更
   - バリデーションの挙動変更

### 回避策
- 段階的アップグレード（6.1 → 7.0）
- 十分なテスト実行
- 本番環境での段階的デプロイ

## ロールバック計画

1. **データベース**: マイグレーションのロールバック準備
2. **Gemfile.lock**: バックアップ保存
3. **設定ファイル**: Git履歴での管理
4. **デプロイ**: Blue-Greenデプロイでの安全な切り戻し

## 推定作業時間

- **Phase 1**: 1-2日（依存関係更新・テスト）
- **Phase 2**: 2-3日（Rails本体アップグレード）
- **Phase 3**: 1-2日（テスト修正・動作確認）
- **Phase 4**: 1日（ドキュメント整備）

**合計**: 5-8日